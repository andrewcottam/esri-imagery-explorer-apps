"use strict";(self.webpackChunkimagery_explorer_apps=self.webpackChunkimagery_explorer_apps||[]).push([[2549],{22549:function(e,t,i){i.r(t),i.d(t,{CIMSymbolRasterizer:function(){return g}});var h=i(56053),r=i(97881),s=i(3846),n=i(52644),a=i(9427),o=i(73356),l=i(77234);const c=96/72;class g{constructor(e){this._spatialReference=e,this._imageDataCanvas=null,this._cimResourceManager=new r.A}get _canvas(){return this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas")),this._imageDataCanvas}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(e,t,i,r,s,c,g,y,d,w){if(!e)return null;const{data:m}=e;if(!m||"CIMSymbolReference"!==m.type||!m.symbol)return null;const{symbol:p}=m;c||(c=(0,l.n5)(p));const M=await a.OverrideHelper.resolveSymbolOverrides(m,t,this._spatialReference,s,c,g,y),_=this._cimResourceManager,f=[];n.wp.fetchResources(M,_,f),n.wp.fetchFonts(M,_,f),f.length>0&&await Promise.all(f);const{width:x,height:R}=i;let b=u(c,x,R,r,w);const C=n.wp.getEnvelope(M,b,_);if(!C)return null;C.x===1/0&&(C.x=x+2),C.y===1/0&&(C.y=-R/2),C.width===-1/0&&(C.width=x),C.height===-1/0&&(C.height=R);let v=1,I=0,P=0;switch(p.type){case"CIMPointSymbol":case"CIMTextSymbol":{let e=1;C.width>x&&(e=x/C.width);let t=1;C.height>R&&(t=R/C.height),"preview"===r&&(C.width<x&&(e=x/C.width),C.height<R&&(t=R/C.height)),v=Math.min(e,t),I=C.x+C.width/2,P=C.y+C.height/2}break;case"CIMLineSymbol":if(w){P=C.y+C.height/2,I=C.x+C.width/2;const e=C.width-x,t=C.height-R;b={paths:(0,o.hs)(b.paths,{xmin:-1*C.width/2+e,xmax:C.width/2-e,ymin:-1*C.height/2+t,ymax:C.height/2-t,width:C.width-2*e,height:C.height-2*t})}}else{(d||C.height>R)&&(v=R/C.height),P=C.y+C.height/2;const e=C.x*v+x/2,t=(C.x+C.width)*v+x/2,i=(0,h.Rg)(b)?b.paths:(0,h.Bi)(b)?b.rings:null;if(null===i)throw new Error("Bad geometry, can't rasterise symbol!");i[0][0][0]-=e/v,i[0][2][0]-=(t-x)/v}break;case"CIMPolygonSymbol":if(w){P=C.y+C.height/2,I=C.x+C.width/2;const e=C.width-x,t=C.height-R;b={paths:(0,o.hs)(b.rings,{xmin:-1*C.width/2+e,xmax:C.width/2-e,ymin:-1*C.height/2+t,ymax:C.height/2-t,width:C.width-2*e,height:C.height-2*t})}}else{I=C.x+C.width/2,P=C.y+C.height/2;const e=C.x*v+x/2,t=(C.x+C.width)*v+x/2,i=C.y*v+R/2,h=(C.y+C.height)*v+R/2,{rings:r}=b;e<0&&(r[0][0][0]-=e,r[0][3][0]-=e,r[0][4][0]-=e),i<0&&(r[0][0][1]+=i,r[0][1][1]+=i,r[0][4][1]+=i),t>x&&(r[0][1][0]-=t-x,r[0][2][0]-=t-x),h>R&&(r[0][2][1]+=h-R,r[0][3][1]+=h-R)}}const S={type:"cim",data:{type:"CIMSymbolReference",symbol:M}};return this.rasterize(S,x,R,I,P,v,c,1,b)}rasterize(e,t,i,h,r,n,a,o=0,g=null,y=window.devicePixelRatio||1){const{data:d}=e;if(!d||"CIMSymbolReference"!==d.type||!d.symbol)return null;const{symbol:w}=d,m=this._canvas,p=y*c;m.width=t*p,m.height=i*p,a||(a=(0,l.n5)(w)),g||(g=u(a,t,i,"legend")),m.width+=2*o,m.height+=2*o;const M=m.getContext("2d",{willReadFrequently:!0}),_=s.IT.createIdentity();return _.translate(-h,-r),_.scale(n*p,-n*p),_.translate(t*p/2+o,i*p/2+o),M.clearRect(0,0,m.width,m.height),new s.Rj(M,this._cimResourceManager,_,!0).drawSymbol(w,g),M.getImageData(0,0,m.width,m.height)}}function u(e,t,i,h,r){const s=-t/2+1,n=t/2-1,a=i/2-1,l=-i/2+1;if(r&&("esriGeometryPolygon"===e||"esriGeometryPolyline"===e)){const h=function(e,t,i,h){return"esriGeometryPolygon"===t?{rings:(0,o.Tl)((0,o.hs)(e.rings,{xmin:0,ymin:0,width:i,height:h}),-1*i/2,-1*h/2)}:"esriGeometryPolyline"===t?{paths:(0,o.Tl)((0,o.hs)(e.paths,{xmin:0,ymin:0,width:i,height:h}),-1*i/2,-1*h/2)}:null}(r,e,t,i);if(h)return h}switch(e){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[n,0]]]};default:return"legend"===h?{rings:[[[s,a],[n,0],[n,l],[s,l],[s,a]]]}:{rings:[[[s,a],[n,a],[n,l],[s,l],[s,a]]]}}}},97881:function(e,t,i){i.d(t,{A:function(){return s}});var h=i(47111),r=i(73027);class s{constructor(){this._resourceMap=new Map,this._inFlightResourceMap=new Map,this.geometryEngine=null,this.geometryEnginePromise=null}destroy(){this._inFlightResourceMap.clear(),this._resourceMap.clear()}getResource(e){return this._resourceMap.get(e)??null}async fetchResource(e,t){const i=this._resourceMap.get(e);if(i)return{width:i.width,height:i.height};let h=this._inFlightResourceMap.get(e);return h?h.then((e=>({width:e.width,height:e.height}))):(h=(0,r.M5)(e,t),this._inFlightResourceMap.set(e,h),h.then((t=>(this._inFlightResourceMap.delete(e),this._resourceMap.set(e,t),{width:t.width,height:t.height})),(()=>({width:0,height:0}))))}deleteResource(e){this._inFlightResourceMap.delete(e),this._resourceMap.delete(e)}loadFont(e){return(0,h.Al)(e)}}}}]);